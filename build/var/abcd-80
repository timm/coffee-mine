#!/usr/bin/env coffee
# Copyright (c) 2011,2012 Tim Menzies, MIT License
# 
#    ##    #####    ####   #####
#   #  #   #    #  #    #  #    #
#  #    #  #####   #       #    #
#  ######  #    #  #       #    #
#  #    #  #    #  #    #  #    #
#  #    #  #####    ####   #####
# 
# Version ....... : abcd-80
# Built ......... : Sat Dec 31 17:35:33 EST 2011
# License ....... : see below.
# Installation .. : see below.
# Report bugs ... : https://github.com/timm/coffee-mine/issues
# For doco ...... : read http://coffee.unbox.org around Sat Dec 31 17:35:33 EST 2011
 
#--| lib/globals.coffee |-------------------------------------------------------------
 
pow  = Math.pow
e    = Math.E
pi   = Math.PI
sqrt = Math.sqrt
ln   = Math.log
show = console.log

inf  = 1e+32
ninf = -1 * inf

d2 = (n) -> Math.round(n*100)/100

d3 = (n) -> Math.round(n*1000)/1000

d4 = (n) -> Math.round(n*10000)/10000
 
#--| lib/abcd.coffee |-------------------------------------------------------------
 
class ABCD
  constructor: () ->
    @a   = {} ; @b  = {} ; @c   = {} ; @d = {}
    @yes = 0  ; @no = 0  ; @all = {}

  add:(actual,predicted) ->
    @known(actual)
    @known(predicted)
    if actual is predicted then @yes +=1 else @no += 1
    for target,ignore of @all
      @known(target)
      if (actual is target)
        if predicted is actual then @d[target] += 1 else @b[target] += 1
      else
        if predicted is target then @c[target] += 1 else @a[target] += 1

  known: (x) ->
    @a[x]   or= 0
    @b[x]   or= 0
    @c[x]   or= 0
    @d[x]   or= 0
    @all[x] or= 0
    @a[x]= @yes + @no if (@all[x] += 1) is 1

  report1: (k,a,b,c,d) ->
    o    = (n) -> (d3 n) * 100
    acc  = pd = pf = prec = f = g = pn = 0
    pd   = d     / (b+d) if (b+d) > 0
    pf   = c     / (a+c) if (a+c) > 0
    pn   = (b+d) / (a+c) if (a+c) > 0
    prec = d     / (c+d) if (c+d) > 0
    g    = 2*(1-pf)*pd / (1-pf+pd)  if (1-pf+pd)    > 0
    f    = 2*prec*pd   / (prec+pd)  if (prec+pd)    > 0
    acc  = @yes        / (@yes+@no)  if (@yes+@no) > 0
    out  = {a: a, b: b, c: c, d: d, pn: o(pn), acc: o(acc)}
    out.pd   = o(pd)
    out.pf   = o(pf)
    out.prec = o(prec)
    out.f    = o(f)
    out.g    = o(g)
    out

  report: () ->
    out = {}
    for k,val of @all
      out[k] = @report1 k,@a[k],@b[k],@c[k],@d[k]
    out
 
#--| abcd.coffee |-------------------------------------------------------------
 
abcd = new ABCD
abcd.add("yes","yes") for i in [1..6]
abcd.add("no","no") for i in [1..2]
abcd.add("maybe","maybe") for i in [1..5]
abcd.add("maybe","no")
show abcd.report()
#
# === Detailed Accuracy By Class ===
#                TP Rate   FP Rate   Precision   Recall  F-Measure   ROC Area  Class
#                  1         0          1         1         1          1        yes
#                  1         0.083      0.667     1         0.8        0.938    no
#                  0.833     0          1         0.833     0.909      0.875    maybe
# Weighted Avg.    0.929     0.012      0.952     0.929     0.932      0.938
# === Confusion Matrix ===
#  a b c   <-- classified as
#  6 0 0 | a = yes
#  0 2 0 | b = no
# 0 1 5 | c = maybe
 
# CREDITS
# =======
# 
# Tim Menzies tim@menzies.us
# 
# INSTALL
# =======
# 
# 0)  Essential first step: make yourself a cup of coffee.
# 1)  Install coffee on your local machine.
# 
# 2)  Download this file and call it, say,  'lib/globals.coffee'.
#     2a) Optional (UNIX systems only)
# 
#        chmod +x lib/globals.coffee  # <=== On UNIX systems
# 
# 3)  Look for 'data/' in this file. Usually, its the last few
#     lines of code (above). If you see any reference to such 
#     a data file, then...
#     3a) Download those data files from
#         http://now.unbox.org/all/trunk/doc/coffee-mine/data
#     3b) Edit this file so it points to those data files.
# 
# 4)  See if this file runs:
# 
#         ./lib/globals.coffee         # <=== UNIX systems
#         coffee lib/globals.coffee    # <=== for other systems
# 
# To check if it is running correctly, see http://coffee.unbox.com 
# (look for blogs entries around abcd.coffee).
# 
# COPYRIGHT
# ---------
# 
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the "Software"),
# to deal in the Software without restriction, including without limitation
# the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom the
# Software is furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included
# in all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
# OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
# OTHER DEALINGS IN THE SOFTWARE.
# 
